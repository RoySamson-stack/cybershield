"""Malware analysis models for threat intelligence collection"""
from django.db import models
from django.utils import timezone
from django.core.validators import MinValueValidator, MaxValueValidator
import uuid
import hashlib


class MalwareSample(models.Model):
    """Malware samples submitted for analysis"""
    STATUS_CHOICES = [
        ('pending', 'Pending Analysis'),
        ('analyzing', 'Analyzing'),
        ('completed', 'Analysis Complete'),
        ('failed', 'Analysis Failed'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    organization = models.ForeignKey(
        'core.Organization',
        on_delete=models.CASCADE,
        related_name='malware_samples',
        null=True,
        blank=True
    )
    
    # File information
    file_name = models.CharField(max_length=500)
    file_size = models.BigIntegerField()  # Size in bytes
    file_type = models.CharField(max_length=100)  # MIME type or file extension
    md5_hash = models.CharField(max_length=32, db_index=True, unique=True)
    sha1_hash = models.CharField(max_length=40, db_index=True)
    sha256_hash = models.CharField(max_length=64, db_index=True, unique=True)
    
    # Storage
    file_path = models.CharField(max_length=1000, blank=True, null=True)  # Path to stored file
    is_stored = models.BooleanField(default=False)  # Whether file is stored locally
    
    # Analysis status
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='pending')
    submitted_at = models.DateTimeField(auto_now_add=True)
    analyzed_at = models.DateTimeField(null=True, blank=True)
    
    # Threat classification
    is_malicious = models.BooleanField(default=False)
    threat_score = models.IntegerField(
        default=0,
        validators=[MinValueValidator(0), MaxValueValidator(100)]
    )
    threat_family = models.CharField(max_length=255, blank=True, null=True)  # e.g., "Trojan", "Ransomware"
    threat_type = models.CharField(max_length=255, blank=True, null=True)  # More specific type
    
    # Metadata
    metadata = models.JSONField(default=dict)  # Additional analysis data
    tags = models.JSONField(default=list)  # Tags for categorization
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'malware_samples'
        indexes = [
            models.Index(fields=['md5_hash']),
            models.Index(fields=['sha256_hash']),
            models.Index(fields=['status', 'created_at']),
            models.Index(fields=['is_malicious', 'threat_score']),
            models.Index(fields=['threat_family', 'created_at']),
        ]
        ordering = ['-submitted_at']
    
    def __str__(self):
        return f"{self.file_name} ({self.sha256_hash[:16]}...)"
    
    def calculate_hashes(self, file_content):
        """Calculate MD5, SHA1, SHA256 hashes"""
        self.md5_hash = hashlib.md5(file_content).hexdigest()
        self.sha1_hash = hashlib.sha1(file_content).hexdigest()
        self.sha256_hash = hashlib.sha256(file_content).hexdigest()


class VirusTotalAnalysis(models.Model):
    """VirusTotal API analysis results"""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    sample = models.OneToOneField(
        MalwareSample,
        on_delete=models.CASCADE,
        related_name='virustotal_analysis'
    )
    
    # VirusTotal response data
    scan_id = models.CharField(max_length=255, blank=True, null=True)
    permalink = models.URLField(blank=True, null=True)
    
    # Detection results
    positives = models.IntegerField(default=0)  # Number of engines that detected malware
    total_engines = models.IntegerField(default=0)  # Total number of engines
    detection_ratio = models.DecimalField(
        max_digits=5,
        decimal_places=2,
        null=True,
        blank=True
    )  # positives / total_engines
    
    # Engine results
    engine_results = models.JSONField(default=dict)  # Detailed results from each engine
    
    # Scan metadata
    scan_date = models.DateTimeField(null=True, blank=True)
    first_seen = models.DateTimeField(null=True, blank=True)
    last_seen = models.DateTimeField(null=True, blank=True)
    
    # Additional data
    additional_info = models.JSONField(default=dict)  # Behavior, network, etc.
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'virustotal_analyses'
        ordering = ['-scan_date']
    
    def __str__(self):
        return f"VT Analysis: {self.sample.file_name} ({self.positives}/{self.total_engines})"


class BehavioralAnalysis(models.Model):
    """Behavioral analysis of malware samples"""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    sample = models.OneToOneField(
        MalwareSample,
        on_delete=models.CASCADE,
        related_name='behavioral_analysis'
    )
    
    # File system operations
    files_created = models.JSONField(default=list)
    files_modified = models.JSONField(default=list)
    files_deleted = models.JSONField(default=list)
    files_read = models.JSONField(default=list)
    
    # Registry operations (Windows)
    registry_keys_created = models.JSONField(default=list)
    registry_keys_modified = models.JSONField(default=list)
    
    # Network activity
    network_connections = models.JSONField(default=list)  # IPs, ports, protocols
    dns_queries = models.JSONField(default=list)
    http_requests = models.JSONField(default=list)
    domains_contacted = models.JSONField(default=list)
    
    # Process operations
    processes_created = models.JSONField(default=list)
    processes_injected = models.JSONField(default=list)
    
    # System modifications
    services_created = models.JSONField(default=list)
    scheduled_tasks_created = models.JSONField(default=list)
    
    # Indicators of Compromise (IOCs)
    iocs = models.JSONField(default=dict)  # IPs, domains, hashes, etc.
    
    # Analysis metadata
    analysis_duration = models.IntegerField(null=True, blank=True)  # Seconds
    sandbox_environment = models.CharField(max_length=255, blank=True, null=True)
    analysis_tool = models.CharField(max_length=255, blank=True, null=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'behavioral_analyses'
        ordering = ['-created_at']
    
    def __str__(self):
        return f"Behavioral Analysis: {self.sample.file_name}"


class ThreatPattern(models.Model):
    """ML-learned threat patterns and techniques"""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Pattern identification
    pattern_name = models.CharField(max_length=255)
    pattern_type = models.CharField(
        max_length=50,
        choices=[
            ('technique', 'Attack Technique'),
            ('behavior', 'Behavioral Pattern'),
            ('signature', 'Signature Pattern'),
            ('ioc', 'Indicator Pattern'),
            ('family', 'Malware Family Pattern'),
        ]
    )
    
    # Pattern characteristics
    description = models.TextField()
    indicators = models.JSONField(default=dict)  # What to look for
    techniques = models.JSONField(default=list)  # MITRE ATT&CK techniques
    
    # ML model data
    confidence_score = models.DecimalField(
        max_digits=5,
        decimal_places=4,
        validators=[MinValueValidator(0.0), MaxValueValidator(1.0)]
    )
    sample_count = models.IntegerField(default=0)  # Number of samples that match
    first_detected = models.DateTimeField(auto_now_add=True)
    last_seen = models.DateTimeField(auto_now=True)
    
    # Trend analysis
    detection_frequency = models.JSONField(default=dict)  # Time-series data
    is_trending = models.BooleanField(default=False)
    trend_score = models.DecimalField(
        max_digits=5,
        decimal_places=4,
        null=True,
        blank=True
    )
    
    # Metadata
    tags = models.JSONField(default=list)
    severity = models.CharField(
        max_length=20,
        choices=[
            ('low', 'Low'),
            ('medium', 'Medium'),
            ('high', 'High'),
            ('critical', 'Critical'),
        ],
        default='medium'
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'threat_patterns'
        indexes = [
            models.Index(fields=['pattern_type', 'is_trending']),
            models.Index(fields=['severity', 'confidence_score']),
            models.Index(fields=['last_seen']),
        ]
        ordering = ['-confidence_score', '-last_seen']
    
    def __str__(self):
        return f"{self.pattern_name} ({self.pattern_type})"


class ThreatIntelligence(models.Model):
    """Aggregated threat intelligence feed for pro users"""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Intelligence summary
    title = models.CharField(max_length=500)
    description = models.TextField()
    summary = models.TextField(blank=True, null=True)
    
    # Threat classification
    threat_type = models.CharField(max_length=100)  # Ransomware, Trojan, etc.
    threat_family = models.CharField(max_length=255, blank=True, null=True)
    severity = models.CharField(
        max_length=20,
        choices=[
            ('low', 'Low'),
            ('medium', 'Medium'),
            ('high', 'High'),
            ('critical', 'Critical'),
        ],
        default='medium'
    )
    
    # Related data
    related_samples = models.ManyToManyField(MalwareSample, blank=True)
    related_patterns = models.ManyToManyField(ThreatPattern, blank=True)
    
    # Key indicators
    iocs = models.JSONField(default=dict)  # IPs, domains, hashes, etc.
    techniques = models.JSONField(default=list)  # MITRE ATT&CK
    
    # Trend data
    detection_timeline = models.JSONField(default=list)  # Time-series detection data
    affected_regions = models.JSONField(default=list)
    affected_industries = models.JSONField(default=list)
    
    # ML insights
    ml_insights = models.JSONField(default=dict)  # ML-generated insights
    prediction_confidence = models.DecimalField(
        max_digits=5,
        decimal_places=4,
        null=True,
        blank=True
    )
    
    # Metadata
    source = models.CharField(max_length=255, default='cybershield_ml')
    is_verified = models.BooleanField(default=False)
    tags = models.JSONField(default=list)
    
    # Access control (pro-tier only)
    requires_pro_tier = models.BooleanField(default=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'threat_intelligence'
        indexes = [
            models.Index(fields=['severity', 'created_at']),
            models.Index(fields=['threat_type', 'created_at']),
            models.Index(fields=['requires_pro_tier', 'created_at']),
        ]
        ordering = ['-severity', '-created_at']
    
    def __str__(self):
        return f"{self.title} ({self.severity})"






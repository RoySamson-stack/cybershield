"""ViewSets for malware analysis API"""
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from django.db.models import Q
from .models import (
    MalwareSample,
    VirusTotalAnalysis,
    BehavioralAnalysis,
    ThreatPattern,
    ThreatIntelligence
)
from .serializers import (
    MalwareSampleSerializer,
    VirusTotalAnalysisSerializer,
    BehavioralAnalysisSerializer,
    ThreatPatternSerializer,
    ThreatIntelligenceSerializer
)
from apps.core.permissions import IsOrganizationMember
from apps.core.models import Organization


class MalwareSampleViewSet(viewsets.ModelViewSet):
    """ViewSet for malware samples"""
    serializer_class = MalwareSampleSerializer
    permission_classes = [IsAuthenticated]
    
    def get_queryset(self):
        """Filter samples by organization"""
        organization = self.request.organization
        if organization:
            return MalwareSample.objects.filter(organization=organization)
        return MalwareSample.objects.none()
    
    def perform_create(self, serializer):
        """Create sample with organization"""
        serializer.save(organization=self.request.organization)
    
    @action(detail=True, methods=['post'])
    def analyze(self, request, pk=None):
        """Trigger analysis for a sample"""
        sample = self.get_object()
        
        from .services import VirusTotalService, BehavioralAnalysisService
        
        # VirusTotal analysis
        vt_service = VirusTotalService()
        vt_service.analyze_sample(sample)
        
        # Behavioral analysis (if file available)
        if sample.is_stored:
            behavior_service = BehavioralAnalysisService()
            behavior_service.analyze_sample(sample)
        
        sample.refresh_from_db()
        return Response(MalwareSampleSerializer(sample).data)


class ThreatIntelligenceViewSet(viewsets.ReadOnlyModelViewSet):
    """ViewSet for threat intelligence (pro-tier only)"""
    serializer_class = ThreatIntelligenceSerializer
    permission_classes = [IsAuthenticated]
    
    def get_queryset(self):
        """Filter by pro-tier access"""
        organization = self.request.organization
        
        if not organization or not organization.subscription:
            return ThreatIntelligence.objects.none()
        
        # Check if user has pro-tier access
        subscription = organization.subscription
        has_access = (
            subscription.plan_type in ['professional', 'enterprise'] or
            subscription.has_threat_intelligence
        )
        
        if not has_access:
            return ThreatIntelligence.objects.none()
        
        queryset = ThreatIntelligence.objects.filter(requires_pro_tier=True)
        
        # Filter by threat type
        threat_type = self.request.query_params.get('threat_type')
        if threat_type:
            queryset = queryset.filter(threat_type=threat_type)
        
        # Filter by severity
        severity = self.request.query_params.get('severity')
        if severity:
            queryset = queryset.filter(severity=severity)
        
        return queryset.order_by('-severity', '-created_at')
    
    @action(detail=False, methods=['get'])
    def trends(self, request):
        """Get trending threats"""
        queryset = self.get_queryset()
        
        # Get trending patterns
        trending_patterns = ThreatPattern.objects.filter(
            is_trending=True
        ).order_by('-trend_score')[:10]
        
        # Get recent high-severity intelligence
        recent_intelligence = queryset.filter(
            severity__in=['high', 'critical']
        )[:10]
        
        return Response({
            'trending_patterns': ThreatPatternSerializer(trending_patterns, many=True).data,
            'recent_intelligence': ThreatIntelligenceSerializer(recent_intelligence, many=True).data
        })


class ThreatPatternViewSet(viewsets.ReadOnlyModelViewSet):
    """ViewSet for threat patterns (pro-tier only)"""
    serializer_class = ThreatPatternSerializer
    permission_classes = [IsAuthenticated]
    
    def get_queryset(self):
        """Filter by pro-tier access"""
        organization = self.request.organization
        
        if not organization or not organization.subscription:
            return ThreatPattern.objects.none()
        
        subscription = organization.subscription
        has_access = (
            subscription.plan_type in ['professional', 'enterprise'] or
            subscription.has_threat_intelligence
        )
        
        if not has_access:
            return ThreatPattern.objects.none()
        
        queryset = ThreatPattern.objects.all()
        
        # Filter by pattern type
        pattern_type = self.request.query_params.get('pattern_type')
        if pattern_type:
            queryset = queryset.filter(pattern_type=pattern_type)
        
        # Filter by trending
        is_trending = self.request.query_params.get('is_trending')
        if is_trending == 'true':
            queryset = queryset.filter(is_trending=True)
        
        return queryset.order_by('-confidence_score', '-last_seen')








